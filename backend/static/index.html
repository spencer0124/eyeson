<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="chatstyle.css" rel="stylesheet" type="text/css" />
    <title>Museum Chat</title>
</head>
<body>
    <!-- container -->
    <div class="flex flex-col items-center w-full">
        <div class="flex flex-col justify-center items-center bg-zinc-200 max-w-screen-md rounded">
            
            <!-- title -->
            <div class="flex flex-row justify-between items-center m-3 w-full">
                <div class="flex flex-row items-center m-3 font-semibold text-2xl">
                    <div id="museum">(전시명)</div>
                    <div>이야기 나누기</div>
                </div>
                <div class="flex items-center m-3 font-semibold">
                    <div id="date-container"></div> 
                </div>
            
            <!-- chats -->   
            </div>
            <div>
                <!-- 작품 정보 받아서 이미지 넣어야 함 -->
                <div>images</div>
                <!-- <img id="artwork-image" src="" alt="Artwork will appear here" style="width: 300px; height: auto;" /> -->
                <ul id="messages"></ul>
            </div>
            
            <!-- send chat -->
            <div class="flex w-full">
                <input id="messageInput" class="grow m-2 rounded border-0" placeholder="관람평을 나누어보세요"/>
                <!-- <textarea id="messageInput" placeholder="Enter your message"></textarea> -->
                <button id="sendMessageBtn" class="bg-green-900 rounded text-white m-2 p-2 border-0 shadow-sm">전송하기</button>
            </div>
        </div>
    </div>
    
    <script src="artwork.js"></script>
    <script src="timescript.js"></script>

    <!-- <h2>Museum Chat</h2>
    <div>
        <label for="museum">Museum Name:</label>
        <input type="text" id="museum" placeholder="Enter museum name">
    </div>
    <div>
        <label for="artworkid">Artwork ID:</label>
        <input type="text" id="artworkid" placeholder="Enter artwork ID">
    </div>
    <div>
        <button id="connectBtn">Connect to Chat</button>
    </div> -->
    <div>
        <h3>Museum Name:</h3>
        <h3 id="museum"></h3>
    </div>
    <div>
        <h3>Chat Messages:</h3>
        <ul id="messages"></ul>
    </div>
    <div>
        <textarea id="messageInput" placeholder="Enter your message"></textarea>
        <button id="sendMessageBtn">Send Message</button>
    </div> 

    <script>
        let socket;
        let museumName;
        let artworkid;

        // Function to parse query parameters
        function getQueryParams() {
            const params = {};
            const queryString = window.location.search.substring(1);
            const pairs = queryString.split("&");
            for (let pair of pairs) {
                const [key, value] = pair.split("=");
                if (key) {
                    params[decodeURIComponent(key)] = decodeURIComponent(value || '');
                }
            }
            return params;
        }

        // Auto-connect if query parameters are present
        window.onload = function() {
            const params = getQueryParams();
            if (params["museum"]) {
                museumName = params["museum"];
                artworkid = params["artworkid"] || "unknown";
                console.log('artworkid', artworkid)

                const museumMapping = {
                    "240904_everymoment": "나의 모든 순간",
                };
                const displayName = museumMapping[museumName] || museumName;
                document.getElementById('museum').textContent = displayName;

                connectWebSocket(museumName, artworkid);
            }
        }

        function connectWebSocket(museum, artworkidParam) {
            if (socket) {
                socket.close();
            }

            socket = new WebSocket(`ws://43.201.93.53:8000/chat/ws/${museum}?artworkid=${encodeURIComponent(artworkidParam)}`);

            socket.onopen = function(event) {
                console.log('WebSocket is connected!');
            };
            
            socket.onmessage = function(event) {
                const message = JSON.parse(event.data);
                const messageElement = document.createElement("li");

                // messageElement.textContent = `[${message.timestamp}] ${message.username}: ${message.content}`;
                // document.getElementById("messages").appendChild(messageElement);

                const artworkImage = document.createElement("img");
                artworkImage.style.width = "30px";  // 원하는 크기 설정
                artworkImage.style.height = "auto";
                artworkImage.id = "artwork-image";
                artworkImage.alt = "Artwork will appear here";  // alt 텍스트 추가
                getArtwork(artworkidParam)

                messageElement.appendChild(artworkImage);
                document.getElementById("messages").appendChild(messageElement);
            };

            socket.onclose = function(event) {
                console.log(event);
                console.log('WebSocket is closed!');
            };
        }

        document.getElementById('sendMessageBtn').addEventListener('click', function() {
            const message = document.getElementById('messageInput').value;
            if (socket && message) {
                socket.send(message); // 서버로 메시지 전송
                document.getElementById('messageInput').value = ''; // 메시지 입력칸 비우기
            }
        });
    </script>
</body>
</html>