<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="chatstyle.css" rel="stylesheet" type="text/css" />
    <title>Museum Chat</title>
</head>
<body>
    <!-- container -->
    <div class="flex flex-col items-center w-full">
        <div class="flex flex-col justify-center items-center bg-zinc-200 max-w-screen-md rounded">
            
            <!-- title -->
            <div class="flex flex-col justify-between items-center m-2 w-full">
                <div class="flex flex-row items-center m-3 font-semibold text-xl">
                    <div>&lt;</div>
                    <div id="museum">(전시명)</div>
                    <div>&gt;</div>
                    <div>&nbsp;이야기 나누기</div>
                </div>
                <div class="flex justify-end items-center m-2 font-semibold">
                    <div id="date-container"></div>
                </div>   
            </div>
            <div class="w-full border-t border-slate-400"></div>

            <!-- chats --> 
            <div class="flex flex-col w-full">
                <!-- <ul>
                    <li class="flex flex-row justify-end items-end m-2">
                        <div class="timestampStyle">time</div>
                        <div class="contentStyle">chat</div>
                        <div>
                            <div class="userStyle">user name</div>
                            <img id="artwork-image" src="" alt="Artwork will appear here" style="width: 30px; height: auto;" />
                        </div>

                    </li>
                </ul> -->
                <ul id="messages"></ul>
            </div>
            
            <!-- send chat -->
            <div class="flex w-full">
                <input id="messageInput" class="grow m-2 rounded border-0" placeholder="관람평을 나누어보세요"/>
                <button id="sendMessageBtn" class="bg-green-900 rounded text-white m-2 p-2 border-0 shadow-sm">전송하기</button>
            </div>
        </div>
    </div>
    
    <script src="timescript.js"></script>
    <script>
        let socket;
        let museumName;
        let artworkid;

        // Function to parse query parameters
        const getQueryParams = () => {
            const params = {};
            const queryString = window.location.search.substring(1);
            const pairs = queryString.split("&");
            for (let pair of pairs) {
                const [key, value] = pair.split("=");
                if (key) {
                    params[decodeURIComponent(key)] = decodeURIComponent(value || '');
                }
            }
            return params;
        }

        // Auto-connect if query parameters are present
        window.onload = () => {
            const params = getQueryParams();
            if (params["museum"]) {
                museumName = params["museum"];
                artworkid = params["artworkid"] || "unknown";
                console.log('artworkid', artworkid)

                const museumMapping = {
                    "240904_everymoment": "나의 모든 순간",
                };
                const displayName = museumMapping[museumName] || museumName;
                document.getElementById('museum').textContent = displayName;

                connectWebSocket(museumName, artworkid);
            }
        }

        const connectWebSocket = (museum, artworkidParam) => {
            if (socket) {
                socket.close();
            }

            socket = new WebSocket(`ws://43.201.93.53:8000/chat/ws/${museum}?artworkid=${encodeURIComponent(artworkidParam)}`);

            socket.onopen = (event) => {
                console.log('WebSocket is connected!');
            };
            
            socket.onmessage = (event) => {
                const message = JSON.parse(event.data);
                const userName = message.username
                const parsedTitle = extractTitleFromName(userName);
                const parsedName = extractUserNameFromName(userName);
                const messageElement = document.createElement("li");

                if (message.username == "System") {
                    messageElement.textContent = `[${message.timestamp}] ${message.username}: ${message.content}`;
                    messageElement.classList.add("sysAlertStyle")
                }
                else {
                    messageElement.classList.add("flex", "flex-row", "justify-end", "items-end", "m-2")

                    const timestampElement = document.createElement("div");
                    timestampElement.classList.add("timestampStyle");
                    timestampElement.textContent = message.timestamp;

                    const contentElement = document.createElement("div");
                    contentElement.classList.add("contentStyle");
                    contentElement.textContent = message.content;

                    const userContainerElement = document.createElement("div");

                    const userElement = document.createElement("div");
                    userElement.classList.add("userStyle");
                    
                    // 줄 바꿈을 위한 별도의 <br> 요소 생성
                    const nameElement = document.createElement("span");
                    nameElement.textContent = parsedName;

                    const breakElement = document.createElement("br");

                    const titleElement = document.createElement("span");
                    titleElement.textContent = parsedTitle;

                    userElement.appendChild(nameElement);
                    userElement.appendChild(breakElement);
                    userElement.appendChild(titleElement);

                    const artworkImage = document.createElement("img");
                    artworkImage.style.width = "30px";  // 원하는 크기 설정
                    artworkImage.style.height = "auto";
                    artworkImage.classList.add("artwork-image", "text-xs");
                    artworkImage.alt = "Artwork will appear";  // alt 텍스트 추가
                    getArtwork(parsedTitle, artworkImage)

                    userContainerElement.appendChild(artworkImage)
                    userContainerElement.appendChild(userElement)

                    messageElement.appendChild(timestampElement);
                    messageElement.appendChild(contentElement);
                    messageElement.appendChild(userContainerElement);
                    // messageElement.appendChild(artworkImage);
                    // messageElement.appendChild(userElement);
                }

                document.getElementById("messages").appendChild(messageElement);

                // console.log('param', parsedTitle)
                // if (userName != "System") {
                //     const artworkImage = document.createElement("img");
                //     artworkImage.style.width = "30px";  // 원하는 크기 설정
                //     artworkImage.style.height = "auto";
                //     artworkImage.classList.add("artwork-image", "text-xs");
                //     artworkImage.alt = "Artwork will appear";  // alt 텍스트 추가
                //     getArtwork(parsedTitle, artworkImage)

                //     messageElement.appendChild(artworkImage);
                //     document.getElementById("messages").appendChild(messageElement);
                // }
            };

            socket.onclose = (event) => {
                console.log(event);
                console.log('WebSocket is closed!');
            };
        }

        const extractTitleFromName = (userName) => {
            const regex = /\((.*?)\)/;  // 괄호 안의 내용을 추출하는 정규식
            const match = userName.match(regex);

            if (match && match[1]) {
                return match[1];  // 괄호 안의 내용만 반환
            } else {
                return null;  // 괄호 안에 내용이 없으면 null 반환
            }
        }

        const extractUserNameFromName = (userName) => {
            const regex = /^(.*?)(?=\s?\()/;  // 괄호 전에 있는 부분만 추출
            const match = userName.match(regex);

            if (match && match[1]) {
                return match[1];  // 괄호 앞의 내용만 반환
            } else {
                return null;  // 괄호가 없으면 null 반환
            }
        }

        const getArtwork = (title, artworkImg) => {
            const url = `http://43.201.93.53:8000/chat/download-profile?title=${encodeURIComponent(title)}`;
            
            fetch(url)
                .then(response => response.blob())  // 이미지 데이터를 blob 형태로 받기
                .then(blob => {
                    // Blob을 Object URL로 변환
                    const imageUrl = URL.createObjectURL(blob);

                    // 미리 준비한 <img> 태그의 src 속성에 이미지 URL을 설정
                    // const imgElement = document.getElementById("artwork-image");
                    // imgElement.src = imageUrl;  // 이미지 표시
                    artworkImg.src = imageUrl;
                })
                .catch(error => {
                    console.error("Error:", error);
                });
        }

        document.getElementById('sendMessageBtn').addEventListener('click', () => {
            const message = document.getElementById('messageInput').value;
            if (socket && message) {
                socket.send(message); // 서버로 메시지 전송
                document.getElementById('messageInput').value = ''; // 메시지 입력칸 비우기
            }
        });
    </script>
</body>
</html>